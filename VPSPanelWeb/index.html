<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云控制台首页</title>
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <script type="text/javascript" src="./js/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="./js/bootstrap.js"></script>
    <script type="text/javascript" src="./js/bootstrap-table.js"></script>
    <script type="text/javascript" src="../js/function.js"></script>
    <style type="text/css">
        html {
            width: 100%;
            height: 100%;
        }

        body {
            margin: 0;
            background-color: #F5F5F5;
        }

        .navigation {
            width: 100%;
            height: 50px;
            background-color: #FFFFFF;
            box-shadow: rgba(0, 0, 0, 0.08) 0px 1px 4px 0px;
        }

        .info-frame {
            margin-top: 20px;
            padding: 20px;
            width: 100%;
            height: fit-content;
            background-color: #FFFFFF;
            border-radius: 3px;
            box-shadow: rgba(0, 0, 0, 0.08) 0px 1px 4px 0px;
            overflow: hidden;
        }
        .info-frame .title {    
            font-weight: 600;
            font-size: 18px; 
        }

        .table > thead > tr > th {
            color: #555;
        }
    </style>
    <script type="text/javascript">
        // 公网地址
        var publicip;
        // 服务地区
        var serviceregion;
        // 用户权限
        var identity;

        webinfo();

        $(document).ready(() => {
            var resourcesTable = $('#resourcesTable');
            resourcesTable.bootstrapTable({
                locale: "zh-CN",
                columns: [{
                    field: 'exampleId',
                    title: '实例ID'
                },{
                    field: 'ipAddress',
                    title: 'IP地址'
                },{
                    field: 'payment',
                    title: '付费方式'
                },{
                    field: 'exampleStatus',
                    title: '实例状态'
                }],
                formatNoMatches: () => {
                    return '没有找到资源';
                }
            });
            resourcesTable.bootstrapTable('hideLoading');
            
            $('.create').click(() => {
                window.location.href = "./page/create.html";
            });
        });

        function authorization() {
            let tk = localStorage.getItem('token')
            $.ajax({
                url: apiAddress + 'user/authorization',
                type: 'post',
                data: {token: tk},
                complete: () => {
                    resourcesList();
                },
                success: (data) => {
                    let state = data.state;
                    let datas = data.data;
                    if(state == 200) {
                        $('.username').text(data.data.name);
                        publicip = datas.publicip;
                        serviceregion = datas.serviceregion;
                        identity = datas.identity;

                        if(identity == 'admin') {
                            $('.adminPage-btn').css({
                                display: 'block'
                            });
                        }
                    } else {
                        window.location.href = "./page/login.html";
                    }
                }
            });
        }

        function resourcesList() {
            let tk = localStorage.getItem('token');
            $.ajax({
                url: apiAddress + 'product/myresources',
                type: 'post',
                data: {token: tk},
                complete: () => {
                    loading.hide();
                },
                success: (data) => {
                    var state = data.state;
                    var datas = data.data;
                    if(state == 200) {
                        for(var i = 0; i < datas.length; i++) {
                            state = vmStateFilter(datas[i].state);
                            $("#resourcesTable").bootstrapTable('insertRow',{index: i, row:{
                                exampleId: '<a href="./page/manage.html?uuid=' + datas[i].vmuuid + '">' + datas[i].vmuuid + '</a>',
                                ipAddress: publicip,
                                payment: datas[i].payment,
                                exampleStatus: state
                            }});
                        }
                    }
                }
            });
        }
    </script>
</head>
<body>
    <div class="navigation">
        <div class="container" style="height: 100%; display: flex; align-items: center;">
            <img src="../image/logo.png" width="120px" height="40px"/>
            <div style="display: inline; margin-left: auto;">
                <div class="btn-group personal">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                        <span class="username">^_^</span>
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu pull-right" role="menu">
                        <li><a href="#">基本资料</a></li>
                        <li class="adminPage-btn" style="display: none;"><a href="./page/admin/manage.html">后台管理</a></li>
                        <li class="divider"></li>
                        <li><a href="javascript:void(logout())">注销</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="info-frame">
            <p class="title">新产品快报</p>
            <div>
                无
            </div>
        </div>

        <div class="info-frame">
            <p class="title">我的资源</p>
            <p class="visible-xs-block" style="color: #7f8c8d;">可左右滑动表格查看信息</p>
            <div style="overflow-x: auto;">
                <table id="resourcesTable" class="table table-hover table-responsive" style="min-width:600px;">
                    <thead>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn btn-default create">创建新实例</button>
        </div>
    </div>

    <script>
        // 全屏加载
        var loading = new KZ_Loading();
        loading.show();
    </script>

</body>
</html>